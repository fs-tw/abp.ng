import { CoreModule, ListService } from '@abp/ng.core';
import {
  Confirmation,
  ConfirmationService,
  ThemeSharedModule,
  ToasterService,
} from '@abp/ng.theme.shared';
import { EXTENSIONS_IDENTIFIER } from '@abp/ng.components/extensible';
import { Component, TrackByFunction, inject } from '@angular/core';
import { AbstractControl } from '@angular/forms';
import { IdentityUserService } from '@volo/abp.ng.identity/proxy';
import { e<%= componentNames.className %>Names } from './<%= fileName %>.model';
import { PageModule } from '@abp/ng.components/page';
import {
  CommercialUiModule,
} from '@volo/abp.commercial.ng.ui';
import { <%= componentNames.className %>StateService } from './<%= fileName %>-state.service';
import { <%= componentNames.className %>ListComponent } from './<%= fileName %>-list/<%= fileName %>-list.component';
import { <%= componentNames.className %>ModalComponent } from './<%= fileName %>-modal/<%= fileName %>-modal.component';
import { <%= componentNames.className %>DetailsComponent } from './<%= fileName %>-details/<%= fileName %>-details.component';
import { ActivatedRoute, Router, RouterModule } from '@angular/router';

@Component({
  selector: 'app-<%= fileName %>',
  templateUrl: './<%= fileName %>.component.html',
  providers: [
    ListService,
    {
      provide: EXTENSIONS_IDENTIFIER,
      useValue: e<%= componentNames.className %>Names.<%= componentNames.className %>,
    },
  ],
  standalone: true,
  imports: [
    RouterModule,
    CoreModule,
    ThemeSharedModule,
    CommercialUiModule,
    PageModule,
    <%= componentNames.className %>ModalComponent,

    <%= componentNames.className %>ListComponent,
    <%= componentNames.className %>DetailsComponent
  ],
})
export class <%= componentNames.className %>Component {
  listComponent?: <%= componentNames.className %>ListComponent;

  stateService = inject(<%= componentNames.className %>StateService);

  confirmationService = inject(ConfirmationService);

  service = inject(IdentityUserService);

  toasterService = inject(ToasterService);

  router = inject(Router);

  activatedRoute = inject(ActivatedRoute);

  trackByFn: TrackByFunction<AbstractControl> = (index, item) =>
    Object.keys(item)[0] || index;  

  <%= componentNames.propertyName %>Modal = {
    visible: false,
    id: null
  } as { visible: boolean; id?: string | null }

  onActive($event: object) {
    if ($event instanceof <%= componentNames.className %>ListComponent)
      this.listComponent = $event;
  }  

  navigate(commands: unknown[]) {
    this.router.navigate(commands,{ relativeTo: this.activatedRoute });
  }

  loadDatas(){
    this.listComponent?.list.get();
  }

  onAdd() {
    this.<%= componentNames.propertyName %>Modal.id = null;
    this.<%= componentNames.propertyName %>Modal.visible = true;
  }

  onEdit(id: string) {
    this.<%= componentNames.propertyName %>Modal.id = id;
    this.<%= componentNames.propertyName %>Modal.visible = true;
  }

  delete(id: string, userName: string) {
    this.confirmationService
      .warn(
        'AbpIdentity::UserDeletionConfirmationMessage',
        'AbpIdentity::AreYouSure',
        {
          messageLocalizationParams: [userName],
        }
      )
      .subscribe((status: Confirmation.Status) => {
        if (status === Confirmation.Status.confirm) {
          this.service.delete(id).subscribe(() => this.loadDatas());
        }
      });
  }

  unlock(id: string) {
    this.service.unlock(id).subscribe(() => {
      this.toasterService.success('AbpIdentity::UserUnlocked');
      this.loadDatas();
    });
  }
}
