!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@abp/ng.core"),require("@abp/ng.theme.shared"),require("@angular/core"),require("@ngxs/store"),require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@abp/ng.permission-management",["exports","@abp/ng.core","@abp/ng.theme.shared","@angular/core","@ngxs/store","rxjs","rxjs/operators"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).abp=e.abp||{},e.abp.ng=e.abp.ng||{},e.abp.ng["permission-management"]={}),e.i1,e.ng_theme_shared,e.ng.core,e.i1$1,e.rxjs,e.rxjs.operators)}(this,(function(e,t,n,r,i,s,o){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function a(e,t,n,r){var i,s=arguments.length,o=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(o=(s<3?i(o):s>3?i(t,n,o):i(t,n))||o);return s>3&&o&&Object.defineProperty(t,n,o),o}function p(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}Object.create;function c(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,s=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}return o}function l(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(c(arguments[t]));return e}Object.create;var u=function(e){this.payload=e};u.type="[PermissionManagement] Get Permissions";var m=function(e){this.payload=e};m.type="[PermissionManagement] Update Permissions";var d=function(e){var t=this;this.restService=e,this.apiName="AbpPermissionManagement",this.get=function(e,n){return t.restService.request({method:"GET",url:"/api/permission-management/permissions",params:{providerName:e,providerKey:n}},{apiName:t.apiName})},this.update=function(e,n,r){return t.restService.request({method:"PUT",url:"/api/permission-management/permissions",params:{providerName:e,providerKey:n},body:r},{apiName:t.apiName})}};d.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new d(r.ɵɵinject(t.RestService))},token:d,providedIn:"root"}),d.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],d.ctorParameters=function(){return[{type:t.RestService}]},e.ɵb=function(){function e(e){this.service=e}return e.getPermissionGroups=function(e){return e.permissionRes.groups||[]},e.getEntityDisplayName=function(e){return e.permissionRes.entityDisplayName},e.prototype.permissionManagementGet=function(e,t){var n=e.patchState,r=t.payload,i=void 0===r?{}:r,s=i.providerKey,a=i.providerName;return this.service.get(a,s).pipe(o.tap((function(e){return n({permissionRes:e})})))},e.prototype.permissionManagementUpdate=function(e,t){var n=t.payload;return this.service.update(n.providerName,n.providerKey,{permissions:n.permissions})},e}(),e.ɵb.decorators=[{type:r.Injectable}],e.ɵb.ctorParameters=function(){return[{type:d}]},a([i.Action(u),p("design:type",Function),p("design:paramtypes",[Object,u]),p("design:returntype",void 0)],e.ɵb.prototype,"permissionManagementGet",null),a([i.Action(m),p("design:type",Function),p("design:paramtypes",[Object,m]),p("design:returntype",void 0)],e.ɵb.prototype,"permissionManagementUpdate",null),a([i.Selector(),p("design:type",Function),p("design:paramtypes",[Object]),p("design:returntype",void 0)],e.ɵb,"getPermissionGroups",null),a([i.Selector(),p("design:type",Function),p("design:paramtypes",[Object]),p("design:returntype",String)],e.ɵb,"getEntityDisplayName",null),e.ɵb=a([i.State({name:"PermissionManagementState",defaults:{permissionRes:{}}}),p("design:paramtypes",[d])],e.ɵb);var b=function(){function n(e,t){this.store=e,this.renderer=t,this.hideBadges=!1,this._visible=!1,this.visibleChange=new r.EventEmitter,this.permissions=[],this.selectThisTab=!1,this.selectAllTab=!1,this.modalBusy=!1,this.trackByFn=function(e,t){return t.name}}return Object.defineProperty(n.prototype,"visible",{get:function(){return this._visible},set:function(e){var t=this;e!==this._visible&&(e?this.openModal().subscribe((function(){t._visible=!0,t.visibleChange.emit(!0)})):(this.selectedGroup=null,this._visible=!1,this.visibleChange.emit(!1)))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"selectedGroupPermissions$",{get:function(){var e=this,t="margin-"+("rtl"===document.body.dir?"right":"left")+".px";return this.groups$.pipe(o.map((function(t){return e.selectedGroup?t.find((function(t){return t.name===e.selectedGroup.name})).permissions:[]})),o.map((function(n){return n.map((function(r){var i;return Object.assign(Object.assign({},r),{style:(i={},i[t]=h(n,r),i),isGranted:e.permissions.find((function(e){return e.name===r.name})).isGranted})}))})))},enumerable:!1,configurable:!0}),n.prototype.getChecked=function(e){return(this.permissions.find((function(t){return t.name===e}))||{isGranted:!1}).isGranted},n.prototype.isGrantedByOtherProviderName=function(e){var t=this;return!!e.length&&e.findIndex((function(e){return e.providerName!==t.providerName}))>-1},n.prototype.onClickCheckbox=function(e,t){var n=this;e.isGranted&&this.isGrantedByOtherProviderName(e.grantedProviders)||setTimeout((function(){n.permissions=n.permissions.map((function(t){return e.name===t.name?Object.assign(Object.assign({},t),{isGranted:!t.isGranted}):e.name===t.parentName&&e.isGranted?Object.assign(Object.assign({},t),{isGranted:!1}):e.parentName!==t.name||e.isGranted?t:Object.assign(Object.assign({},t),{isGranted:!0})})),n.setTabCheckboxState(),n.setGrantCheckboxState()}),0)},n.prototype.setTabCheckboxState=function(){var e=this;this.selectedGroupPermissions$.pipe(o.take(1)).subscribe((function(t){var n=t.filter((function(e){return e.isGranted})),r=document.querySelector("#select-all-in-this-tabs");n.length===t.length?(r.indeterminate=!1,e.selectThisTab=!0):0===n.length?(r.indeterminate=!1,e.selectThisTab=!1):r.indeterminate=!0}))},n.prototype.setGrantCheckboxState=function(){var e=this.permissions.filter((function(e){return e.isGranted})),t=document.querySelector("#select-all-in-all-tabs");e.length===this.permissions.length?(t.indeterminate=!1,this.selectAllTab=!0):0===e.length?(t.indeterminate=!1,this.selectAllTab=!1):t.indeterminate=!0},n.prototype.onClickSelectThisTab=function(){var e=this;this.selectedGroupPermissions$.pipe(o.take(1)).subscribe((function(t){t.forEach((function(t){if(!t.isGranted||!e.isGrantedByOtherProviderName(t.grantedProviders)){var n=e.permissions.findIndex((function(e){return e.name===t.name}));e.permissions=l(e.permissions.slice(0,n),[Object.assign(Object.assign({},e.permissions[n]),{isGranted:!e.selectThisTab})],e.permissions.slice(n+1))}}))})),this.setGrantCheckboxState()},n.prototype.onClickSelectAll=function(){var e=this;this.permissions=this.permissions.map((function(t){return Object.assign(Object.assign({},t),{isGranted:e.isGrantedByOtherProviderName(t.grantedProviders)||!e.selectAllTab})})),this.selectThisTab=!this.selectAllTab},n.prototype.onChangeGroup=function(e){this.selectedGroup=e,this.setTabCheckboxState()},n.prototype.submit=function(){var n=this,r=g(this.store.selectSnapshot(e.ɵb.getPermissionGroups)),i=this.permissions.filter((function(e){return r.find((function(t){return t.name===e.name})).isGranted!==e.isGranted})).map((function(e){return{name:e.name,isGranted:e.isGranted}}));i.length?(this.modalBusy=!0,this.store.dispatch(new m({providerKey:this.providerKey,providerName:this.providerName,permissions:i})).pipe(o.switchMap((function(){return n.shouldFetchAppConfig()?n.store.dispatch(t.GetAppConfiguration):s.of(null)})),o.finalize((function(){return n.modalBusy=!1}))).subscribe((function(){n.visible=!1}))):this.visible=!1},n.prototype.openModal=function(){var e=this;if(!this.providerKey||!this.providerName)throw new Error("Provider Key and Provider Name are required.");return this.store.dispatch(new u({providerKey:this.providerKey,providerName:this.providerName})).pipe(o.pluck("PermissionManagementState","permissionRes"),o.tap((function(t){e.selectedGroup=t.groups[0],e.permissions=g(t.groups)})))},n.prototype.initModal=function(){this.setTabCheckboxState(),this.setGrantCheckboxState()},n.prototype.getAssignedCount=function(e){return this.permissions.reduce((function(t,n){return n.name.split(".")[0]===e&&n.isGranted?t+1:t}),0)},n.prototype.shouldFetchAppConfig=function(){var e=this,n=this.store.selectSnapshot(t.ConfigState.getOne("currentUser"));return"R"===this.providerName?n.roles.some((function(t){return t===e.providerKey})):"U"===this.providerName&&n.id===this.providerKey},n}();function h(e,t){var n=e.find((function(e){return e.name===t.parentName}));return n&&n.parentName?20+h(e,n):n?20:0}function g(e){return e.reduce((function(e,t){return l(e,t.permissions)}),[])}b.decorators=[{type:r.Component,args:[{selector:"abp-permission-management",template:'<abp-modal [(visible)]="visible" (init)="initModal()" [busy]="modalBusy">\r\n  <ng-container *ngIf="{ entityName: entityName$ | async } as data">\r\n    <ng-template #abpHeader>\r\n      <h4>\r\n        {{ \'AbpPermissionManagement::Permissions\' | abpLocalization }} - {{ data.entityName }}\r\n      </h4>\r\n    </ng-template>\r\n    <ng-template #abpBody>\r\n      <div class="custom-checkbox custom-control mb-2">\r\n        <input\r\n          type="checkbox"\r\n          id="select-all-in-all-tabs"\r\n          name="select-all-in-all-tabs"\r\n          class="custom-control-input"\r\n          [(ngModel)]="selectAllTab"\r\n          (click)="onClickSelectAll()"\r\n        />\r\n        <label class="custom-control-label" for="select-all-in-all-tabs">{{\r\n          \'AbpPermissionManagement::SelectAllInAllTabs\' | abpLocalization\r\n        }}</label>\r\n      </div>\r\n\r\n      <hr class="mt-2 mb-2" />\r\n      <div class="row">\r\n        <div class="overflow-scroll col-md-4">\r\n          <ul class="nav nav-pills flex-column">\r\n            <li *ngFor="let group of groups$ | async; trackBy: trackByFn" class="nav-item">\r\n              <a\r\n                *ngIf="{ assignedCount: getAssignedCount(group.name) } as data"\r\n                class="nav-link pointer"\r\n                [class.active]="selectedGroup?.name === group?.name"\r\n                (click)="onChangeGroup(group)"\r\n              >\r\n                <div [class.font-weight-bold]="data.assignedCount">\r\n                  {{ group?.displayName }}\r\n                  <span>({{ data.assignedCount }})</span>\r\n                </div>\r\n              </a>\r\n            </li>\r\n          </ul>\r\n        </div>\r\n        <div class="col-md-8 overflow-scroll">\r\n          <h4>{{ selectedGroup?.displayName }}</h4>\r\n          <hr class="mt-2 mb-3" />\r\n          <div class="pl-1 pt-1">\r\n            <div class="custom-checkbox custom-control mb-2">\r\n              <input\r\n                type="checkbox"\r\n                id="select-all-in-this-tabs"\r\n                name="select-all-in-this-tabs"\r\n                class="custom-control-input"\r\n                [(ngModel)]="selectThisTab"\r\n                (click)="onClickSelectThisTab()"\r\n              />\r\n              <label class="custom-control-label" for="select-all-in-this-tabs">{{\r\n                \'AbpPermissionManagement::SelectAllInThisTab\' | abpLocalization\r\n              }}</label>\r\n            </div>\r\n            <hr class="mb-3" />\r\n            <div\r\n              *ngFor="\r\n                let permission of selectedGroupPermissions$ | async;\r\n                let i = index;\r\n                trackBy: trackByFn\r\n              "\r\n              [ngStyle]="permission.style"\r\n              class="custom-checkbox custom-control mb-2"\r\n            >\r\n              <input\r\n                #permissionCheckbox\r\n                type="checkbox"\r\n                [checked]="getChecked(permission.name)"\r\n                [value]="getChecked(permission.name)"\r\n                [attr.id]="permission.name"\r\n                class="custom-control-input"\r\n                [disabled]="isGrantedByOtherProviderName(permission.grantedProviders)"\r\n              />\r\n              <label\r\n                class="custom-control-label"\r\n                [attr.for]="permission.name"\r\n                (click)="onClickCheckbox(permission, permissionCheckbox.value)"\r\n                >{{ permission.displayName }}\r\n                <ng-container *ngIf="!hideBadges">\r\n                  <span\r\n                    *ngFor="let provider of permission.grantedProviders"\r\n                    class="badge badge-light"\r\n                    >{{ provider.providerName }}: {{ provider.providerKey }}</span\r\n                  >\r\n                </ng-container>\r\n              </label>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </ng-template>\r\n    <ng-template #abpFooter>\r\n      <button type="button" class="btn btn-secondary" #abpClose>\r\n        {{ \'AbpIdentity::Cancel\' | abpLocalization }}\r\n      </button>\r\n      <abp-button iconClass="fa fa-check" (click)="submit()">{{\r\n        \'AbpIdentity::Save\' | abpLocalization\r\n      }}</abp-button>\r\n    </ng-template>\r\n  </ng-container>\r\n</abp-modal>\r\n',exportAs:"abpPermissionManagement",styles:["\n      .overflow-scroll {\n        max-height: 70vh;\n        overflow-y: scroll;\n      }\n    "]}]}],b.ctorParameters=function(){return[{type:i.Store},{type:r.Renderer2}]},b.propDecorators={providerName:[{type:r.Input}],providerKey:[{type:r.Input}],hideBadges:[{type:r.Input}],visible:[{type:r.Input}],visibleChange:[{type:r.Output}]},a([i.Select(e.ɵb.getPermissionGroups),p("design:type",s.Observable)],b.prototype,"groups$",void 0),a([i.Select(e.ɵb.getEntityDisplayName),p("design:type",s.Observable)],b.prototype,"entityName$",void 0);var f=function(){};f.decorators=[{type:r.NgModule,args:[{declarations:[b],imports:[t.CoreModule,n.ThemeSharedModule,i.NgxsModule.forFeature([e.ɵb])],exports:[b]}]}];var v=function(){function e(e){this.rest=e,this.apiName="AbpPermissionManagement"}return e.prototype.getPermissions=function(e){var t={method:"GET",url:"/api/permission-management/permissions",params:e};return this.rest.request(t,{apiName:this.apiName})},e.prototype.updatePermissions=function(e){var t={method:"PUT",url:"/api/permission-management/permissions",body:{permissions:e.permissions},params:{providerKey:e.providerKey,providerName:e.providerName}};return this.rest.request(t,{apiName:this.apiName})},e}();v.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new v(r.ɵɵinject(t.RestService))},token:v,providedIn:"root"}),v.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],v.ctorParameters=function(){return[{type:t.RestService}]};var y=function(){function t(e){this.store=e}return t.prototype.getPermissionGroups=function(){return this.store.selectSnapshot(e.ɵb.getPermissionGroups)},t.prototype.getEntityDisplayName=function(){return this.store.selectSnapshot(e.ɵb.getEntityDisplayName)},t.prototype.dispatchGetPermissions=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.store.dispatch(new(u.bind.apply(u,l([void 0],e))))},t.prototype.dispatchUpdatePermissions=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.store.dispatch(new(m.bind.apply(m,l([void 0],e))))},t}();y.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new y(r.ɵɵinject(i.Store))},token:y,providedIn:"root"}),y.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],y.ctorParameters=function(){return[{type:i.Store}]},e.GetPermissions=u,e.PermissionManagementComponent=b,e.PermissionManagementModule=f,e.PermissionManagementService=v,e.PermissionManagementState=e.ɵb,e.PermissionManagementStateService=y,e.PermissionsService=d,e.UpdatePermissions=m,e.ɵa=b,e.ɵc=d,e.ɵd=u,e.ɵe=m,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=abp-ng.permission-management.umd.min.js.map